generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String                @id // Supabase auth.users.id (UUID)
  email         String                @unique
  role          UserRole              @default(VISITOR)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  audits        AuditResult[]
  appointments  CalendlyAppointment[]
  subscriptions UserSubscription[]
}

enum UserRole {
  ADMIN
  VISITOR
}

model AuditResult {
  id                        String                @id @default(cuid())
  url                       String
  userEmail                 String
  user                      User?                 @relation(fields: [userEmail], references: [email])
  clientId                   String?
  client                     Client?               @relation(fields: [clientId], references: [id], onDelete: SetNull)
  isPaid                    Boolean               @default(false)
  hasAppointment            Boolean               @default(false)
  rawSeoJson                Json
  llmSummary                String?
  contentGrade              String?
  competitorJson            Json?
  articleIdeas              Json?
  companyName               String?
  titleSearchRelevanceScore Int?
  technicalFoundationsScore Int?
  aiOptimizationScore       Int?
  contentSemanticsScore     Int?
  mediaOptimizationScore    Int?
  crawlabilityIndexScore    Int?
  createdAt                 DateTime              @default(now())
  appointments              CalendlyAppointment[]
  leads                     Lead[]
  
  @@index([clientId])
}

model CalendlyAppointment {
  id              String       @id @default(cuid())
  calendlyEventId String       @unique
  url             String
  userEmail       String
  user            User?        @relation(fields: [userEmail], references: [email])
  scheduledAt     DateTime
  status          String
  auditId         String?
  audit           AuditResult? @relation(fields: [auditId], references: [id])
  createdAt       DateTime     @default(now())
}

model SubscriptionPlan {
  id            String             @id @default(cuid())
  name          String
  stripeProductId String?
  stripePriceId String?
  priceCents    Int
  subscriptions UserSubscription[]
}

model UserSubscription {
  id                 String           @id @default(cuid())
  userId             String
  user               User             @relation(fields: [userId], references: [id])
  subscriptionPlanId String
  subscriptionPlan   SubscriptionPlan @relation(fields: [subscriptionPlanId], references: [id])
  status             String
  startedAt          DateTime         @default(now())
  canceledAt         DateTime?
}

model AuditJob {
  id           String   @id @default(uuid())
  url          String
  status       String // "pending" | "running" | "done" | "error"
  stage        Int      @default(0) // 0, 1, 2, 3
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  errorMessage String?
  results      Json? // Full audit result object

  @@index([url, status, createdAt])
  @@index([status])
}

// Smokey + Wildcat Models
enum PlanTier {
  STARTER
  GROWTH
  ENTERPRISE
}

enum ClientStatus {
  ANONYMOUS
  PAID_UNLOCK
  MEETING_SCHEDULED
  PROPOSAL_SENT
  SIGNED
  ACTIVE
  DECLINED
  PAUSED
  CANCELLED
  AT_RISK
}

enum ContractStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum TimelineStatus {
  UPCOMING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  RESCHEDULED
}

enum MeetingType {
  DISCOVERY
  ONBOARDING
  QUARTERLY_REVIEW
  AD_HOC
}

enum MeetingSource {
  CALENDLY
  MANUAL
  INBOUND
}

enum LeadSource {
  STRIPE
  CALENDLY
  MANUAL
  INBOUND
}

enum LeadStatus {
  ANONYMOUS
  PAID_UNLOCK
  MEETING_SCHEDULED
  PROPOSAL_SENT
  SIGNED
  ACTIVE
  DECLINED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EmailStatus {
  SENT
  FAILED
  BOUNCED
}

model Lead {
  id            String     @id @default(cuid())
  email         String
  name          String?
  companyName   String?
  canonicalUrl  String?
  status        LeadStatus @default(ANONYMOUS)
  source        LeadSource
  auditId       String?
  audit         AuditResult? @relation(fields: [auditId], references: [id], onDelete: SetNull)
  metadata      Json?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  payments      Payment[]
  client        Client?
  
  @@index([email])
  @@index([status])
}

model Payment {
  id                    String        @id @default(cuid())
  stripeSessionId       String        @unique
  stripePaymentIntentId String?
  leadId                String?
  lead                  Lead?         @relation(fields: [leadId], references: [id], onDelete: SetNull)
  clientId              String?
  client                Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  amountCents           Int
  currency              String        @default("usd")
  status                PaymentStatus @default(PENDING)
  customerName          String?
  companyName           String?
  canonicalUrl          String?
  email                 String
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  
  @@index([leadId])
  @@index([clientId])
  @@index([stripeSessionId])
  @@index([status])
}

model Client {
  id                String   @id @default(cuid())
  email             String
  companyName       String?
  canonicalUrl      String
  planTier          PlanTier @default(STARTER)
  contractStartDate DateTime
  contractLengthMonths Int   @default(12)
  status            ClientStatus @default(ACTIVE)
  leadId            String?  @unique
  lead              Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  contracts        Contract[]
  timelines        ClientTimeline[]
  meetings         Meeting[]
  audits           AuditResult[] // Link to existing audits
  payments         Payment[]
  
  @@index([email])
  @@index([status])
}

model Contract {
  id                String   @id @default(cuid())
  clientId          String
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  startDate         DateTime
  endDate           DateTime
  lengthMonths      Int
  planTier          PlanTier
  status            ContractStatus @default(ACTIVE)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([clientId])
  @@index([status])
}

model TimelineTemplate {
  id            String   @id @default(cuid())
  planTier      PlanTier
  phaseName     String
  dayOffset     Int      // Days from contract start
  toolSequence  Json     // Array of tool configs: [{tool: "audit", required: true}, ...]
  description   String?
  createdAt     DateTime @default(now())
  
  @@unique([planTier, phaseName])
  @@index([planTier])
}

model ClientTimeline {
  id                String   @id @default(cuid())
  clientId          String
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  phaseName         String
  scheduledDate     DateTime
  status            TimelineStatus @default(UPCOMING)
  toolSequence     Json     // Copied from template
  executionResults Json?    // Store tool execution IDs
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([clientId])
  @@index([status])
  @@index([scheduledDate])
}

model Meeting {
  id              String   @id @default(cuid())
  clientId        String?
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  calendlyEventId String? @unique
  email          String
  meetingType    MeetingType
  meetingSource  MeetingSource
  scheduledAt    DateTime
  status         String   @default("scheduled")
  auditTriggered Boolean  @default(false)
  midnightTriggered Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([clientId])
  @@index([email])
  @@index([scheduledAt])
}

model EmailLog {
  id            String   @id @default(cuid())
  recipient     String
  subject       String
  templateType  String
  sentAt        DateTime @default(now())
  status        EmailStatus @default(SENT)
  errorMessage  String?
  metadata      Json?    // Store audit_id, client_id, etc.
  
  @@index([recipient])
  @@index([sentAt])
}

// Auth models removed - using Supabase Auth instead
// Account, Session, and VerificationToken are managed by Supabase
